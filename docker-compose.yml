version: "3.7"
services:
  blog:
    image: blog
    build: ./git
    working_dir: /home
    tty: true
    ports:
      - 9000:9000
    volumes:
      - ./www:/home
      - ./webhook:/webhook
      - ./sh:/sh
    command: 
      - /bin/bash
      - -c
      - |
        rm -rf /home/blog
        cd /home
        git clone git://github.com/Chance-fyi/blog.git
        cd /home/blog
        hugo
        chmod +x -R /sh
        webhook -hooks /webhook/hooks.json -hotreload
  nginx:
    image: nginx
    working_dir: /home
    tty: true
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./www:/home
      - ./sh:/sh
      - ./nginx/conf:/etc/nginx/conf.d
      - ./nginx/cert:/etc/nginx/cert
    command: 
      - /bin/bash
      - -c
      - |
        chmod +x -R /sh
        /sh/wait-for-it.sh blog:9000 -- nginx -g 'daemon off;'